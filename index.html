<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>🎯 Lucky Draw System</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --primary-color: #4f46e5;
                --secondary-color: #7c3aed;
                --accent-color: #f59e0b;
                --success-color: #10b981;
                --danger-color: #ef4444;
                --background: #ffffff;
                --surface: #f8fafc;
                --text-primary: #1e293b;
                --text-secondary: #64748b;
                --border: #e2e8f0;
                --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            }

            [data-theme="dark"] {
                --background: #0f172a;
                --surface: #1e293b;
                --text-primary: #f1f5f9;
                --text-secondary: #94a3b8;
                --border: #334155;
            }

            [data-theme="festival"] {
                --primary-color: #dc2626;
                --secondary-color: #ea580c;
                --accent-color: #fbbf24;
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                margin: 0;
                padding: 0;
                background: var(--background);
                color: var(--text-primary);
                line-height: 1.6;
                transition: all 0.3s ease;
                overflow-x: hidden;
                /* Prevent horizontal scroll */
            }

            /* Main Layout - Three Zone Flexbox */
            .main-layout {
                display: flex;
                min-height: 100vh;
                width: 100%;
            }

            /* Ad Areas */
            .ads-left,
            .ads-right {
                width: 300px;
                min-width: 300px;
                background: var(--surface);
                border-right: 1px solid var(--border);
                border-left: 1px solid var(--border);
                padding: 20px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                position: sticky;
                top: 0;
                height: 100vh;
                overflow-y: auto;
            }

            .ads-left {
                border-right: 1px solid var(--border);
                border-left: none;
            }

            .ads-right {
                border-left: 1px solid var(--border);
                border-right: none;
            }

            .ad-placeholder {
                text-align: center;
                color: var(--text-secondary);
                font-size: 0.9rem;
                width: 100%;
            }

            .ad-placeholder p {
                margin-bottom: 10px;
                font-weight: 600;
            }

            .ad-placeholder small {
                opacity: 0.7;
            }

            /* Main Content Area */
            .content-area {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-width: 0;
                /* Prevents flex item from overflowing */
            }

            /* Container adjustments */
            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                width: 100%;
            }

            .header {
                text-align: center;
                margin-bottom: 30px;
            }

            .header h1 {
                font-size: 2.5rem;
                color: var(--primary-color);
                margin-bottom: 10px;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            }

            .header p {
                color: var(--text-secondary);
                font-size: 1.1rem;
            }

            .version-info {
                text-align: center;
                margin-bottom: 20px;
            }

            .version-info small {
                color: var(--text-secondary);
                opacity: 0.7;
            }

            .version-info a {
                color: var(--primary);
                text-decoration: none;
            }

            .version-info a:hover {
                text-decoration: underline;
            }

            .controls {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-bottom: 30px;
            }

            @media (max-width: 768px) {
                .controls {
                    grid-template-columns: 1fr;
                }
            }

            .input-section,
            .display-section {
                background: var(--surface);
                padding: 25px;
                border-radius: 12px;
                border: 1px solid var(--border);
                box-shadow: var(--shadow);
            }

            .section-title {
                font-size: 1.3rem;
                font-weight: 600;
                margin-bottom: 15px;
                color: var(--primary-color);
            }

            textarea {
                width: 100%;
                min-height: 150px;
                padding: 15px;
                border: 2px solid var(--border);
                border-radius: 8px;
                font-size: 1rem;
                font-family: inherit;
                background: var(--background);
                color: var(--text-primary);
                resize: vertical;
                transition: border-color 0.3s ease;
            }

            textarea:focus {
                outline: none;
                border-color: var(--primary-color);
            }

            .button-group {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                margin-top: 15px;
            }

            .btn {
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }

            .btn-primary {
                background: var(--primary-color);
                color: white;
            }

            .btn-primary:hover {
                background: var(--secondary-color);
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }

            .btn-secondary {
                background: var(--text-secondary);
                color: white;
            }

            .btn-secondary:hover {
                background: var(--text-primary);
                transform: translateY(-2px);
            }

            .btn-success {
                background: var(--success-color);
                color: white;
            }

            .btn-success:hover {
                background: #059669;
                transform: translateY(-2px);
            }

            .btn-danger {
                background: var(--danger-color);
                color: white;
            }

            .btn-danger:hover {
                background: #dc2626;
                transform: translateY(-2px);
            }

            .btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none !important;
            }

            .participants-list {
                max-height: 200px;
                overflow-y: auto;
                background: var(--background);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 15px;
                margin-top: 15px;
            }

            .participant-item {
                padding: 8px 12px;
                margin: 4px 0;
                background: var(--surface);
                border-radius: 6px;
                border-left: 4px solid var(--primary-color);
            }

            .winner-section {
                text-align: center;
                margin: 30px 0;
                padding: 30px;
                background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
                border-radius: 16px;
                color: white;
                box-shadow: var(--shadow-lg);
            }

            .winner-announcement {
                font-size: 2.5rem;
                font-weight: bold;
                margin-bottom: 15px;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            }

            .winner-name {
                font-size: 3rem;
                font-weight: 900;
                margin: 20px 0;
                text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4);
                animation: winnerGlow 2s ease-in-out infinite alternate;
            }

            @keyframes winnerGlow {
                from {
                    text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 255, 255, 0.5);
                }

                to {
                    text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4), 0 0 30px rgba(255, 255, 255, 0.8);
                }
            }

            .spinner {
                font-size: 2rem;
                font-weight: bold;
                color: var(--accent-color);
                margin: 20px 0;
                min-height: 60px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .countdown {
                font-size: 4rem;
                font-weight: 900;
                color: var(--accent-color);
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
                animation: countdownPulse 1s ease-in-out;
            }

            @keyframes countdownPulse {
                0% {
                    transform: scale(1);
                }

                50% {
                    transform: scale(1.2);
                }

                100% {
                    transform: scale(1);
                }
            }

            .history-section {
                background: var(--surface);
                padding: 25px;
                border-radius: 12px;
                border: 1px solid var(--border);
                box-shadow: var(--shadow);
                margin-top: 30px;
            }

            .history-list {
                max-height: 300px;
                overflow-y: auto;
                margin-top: 15px;
            }

            .history-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 16px;
                margin: 8px 0;
                background: var(--background);
                border-radius: 8px;
                border-left: 4px solid var(--success-color);
            }

            .history-winner {
                font-weight: 600;
                color: var(--text-primary);
            }

            .history-time {
                color: var(--text-secondary);
                font-size: 0.9rem;
            }

            .theme-controls {
                display: flex;
                gap: 10px;
                justify-content: center;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }

            .theme-btn {
                padding: 8px 16px;
                border: 2px solid var(--border);
                border-radius: 6px;
                background: var(--surface);
                color: var(--text-primary);
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .theme-btn.active {
                background: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }

            .stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin: 20px 0;
            }

            .stat-card {
                background: var(--surface);
                padding: 20px;
                border-radius: 8px;
                text-align: center;
                border: 1px solid var(--border);
            }

            .stat-number {
                font-size: 2rem;
                font-weight: bold;
                color: var(--primary-color);
            }

            .stat-label {
                color: var(--text-secondary);
                margin-top: 5px;
            }

            .hash-display {
                background: var(--surface);
                padding: 15px;
                border-radius: 8px;
                margin-top: 15px;
                font-family: 'Courier New', monospace;
                font-size: 0.9rem;
                word-break: break-all;
                color: var(--text-secondary);
            }

            .hidden {
                display: none !important;
            }

            .fade-in {
                animation: fadeIn 0.5s ease-in;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .shake {
                animation: shake 0.5s ease-in-out;
            }

            @keyframes shake {

                0%,
                100% {
                    transform: translateX(0);
                }

                25% {
                    transform: translateX(-5px);
                }

                75% {
                    transform: translateX(5px);
                }
            }

            /* Hide ads on mobile and adjust layout */
            @media (max-width: 768px) {
                .main-layout {
                    flex-direction: column;
                }

                .ads-left,
                .ads-right {
                    display: none;
                }

                .content-area {
                    width: 100%;
                }

                .container {
                    padding: 15px;
                }
            }

            @media (max-width: 480px) {
                .container {
                    padding: 10px;
                }

                .header h1 {
                    font-size: 2rem;
                }

                .winner-name {
                    font-size: 2rem;
                }

                .btn {
                    padding: 10px 16px;
                    font-size: 0.9rem;
                }
            }
        </style>
    </head>

    <body>
        <div class="main-layout">
            <!-- Ad Area - Left Side -->
            <div class="ads-left">
                <!-- Insert Google Ads code here -->
                <div class="ad-placeholder">
                    <p>📢 Advertisement Space</p>
                    <small>Left Side Ad Area</small>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="content-area">
                <div class="container">
                    <div class="header">
                        <h1 id="appTitle" data-en="appTitle" data-vi="appTitle">🎯 Lucky Draw System</h1>
                        <p id="appSubtitle" data-en="appSubtitle" data-vi="appSubtitle">Fair and secure random selection
                            using
                            cryptographic randomness</p>
                        <div class="version-info">
                            <small>v1.0.0 | <a href="https://github.com/xemthach/lucky-draw-share"
                                    target="_blank">GitHub</a></small>
                        </div>
                    </div>

                    <div class="theme-controls">
                        <button class="theme-btn active" onclick="setTheme('light')">☀️ <span data-en="Light"
                                data-vi="Sáng">Light</span></button>
                        <button class="theme-btn" onclick="setTheme('dark')">🌙 <span data-en="Dark"
                                data-vi="Tối">Dark</span></button>
                        <button class="theme-btn" onclick="setTheme('festival')">🎉 <span data-en="Festival"
                                data-vi="Lễ hội">Festival</span></button>
                        <button class="theme-btn" onclick="toggleLanguage()">🌐 <span data-en="Language"
                                data-vi="Ngôn ngữ">Language</span></button>
                    </div>

                    <div class="controls">
                        <div class="input-section">
                            <h2 class="section-title">📝 <span data-en="Participants List"
                                    data-vi="Danh sách tham gia">Participants List</span></h2>
                            <textarea id="participantsInput" data-en-placeholder="Enter participants (one per line):
John Doe
Jane Smith
Mike Johnson
Sarah Wilson
..." data-vi-placeholder="Nhập danh sách tham gia (mỗi người một dòng):
Nguyễn Văn A
Trần Thị B
Lê Văn C
Phạm Thị D
..."></textarea>
                            <div class="button-group">
                                <button class="btn btn-primary" onclick="saveList()">💾 <span data-en="Save List"
                                        data-vi="Lưu danh sách">Save List</span></button>
                                <button class="btn btn-secondary" onclick="clearInput()">🗑️ <span data-en="Clear"
                                        data-vi="Xóa">Clear</span></button>
                            </div>
                        </div>

                        <div class="display-section">
                            <h2 class="section-title">📊 <span data-en="Current List"
                                    data-vi="Danh sách hiện tại">Current
                                    List</span></h2>
                            <div id="participantsDisplay" class="participants-list">
                                <p style="color: var(--text-secondary); text-align: center;"
                                    data-en="No participants loaded" data-vi="Chưa có người tham gia">No participants
                                    loaded</p>
                            </div>
                            <div class="stats">
                                <div class="stat-card">
                                    <div class="stat-number" id="totalParticipants">0</div>
                                    <div class="stat-label" data-en="Total Participants" data-vi="Tổng số tham gia">
                                        Total
                                        Participants</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="remainingParticipants">0</div>
                                    <div class="stat-label" data-en="Remaining" data-vi="Còn lại">Remaining</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="winner-section hidden" id="winnerSection">
                        <h2 class="winner-announcement">🎉 <span data-en="CONGRATULATIONS!"
                                data-vi="CHÚC MỪNG!">CONGRATULATIONS!</span> 🎉</h2>
                        <div class="winner-name" id="winnerName"></div>
                        <div class="hash-display" id="resultHash"></div>
                    </div>

                    <div style="text-align: center; margin: 30px 0;">
                        <div class="spinner hidden" id="spinner">🎲 <span data-en="Spinning..."
                                data-vi="Đang quay...">Spinning...</span></div>
                        <div class="countdown hidden" id="countdown">3</div>
                        <div class="button-group" style="justify-content: center;">
                            <button class="btn btn-success" id="spinBtn" onclick="startSpin()" disabled>🎲 <span
                                    data-en="SPIN!" data-vi="QUAY!">SPIN!</span></button>
                            <button class="btn btn-secondary" onclick="resetWinners()">🔄 <span data-en="Reset Winners"
                                    data-vi="Đặt lại người thắng">Reset Winners</span></button>
                            <button class="btn btn-danger" onclick="resetAll()">🗑️ <span data-en="Reset All"
                                    data-vi="Đặt lại tất cả">Reset All</span></button>
                            <button class="btn btn-primary" onclick="exportWinners()">📥 <span data-en="Export Winners"
                                    data-vi="Xuất người thắng">Export Winners</span></button>
                            <button class="btn btn-success" onclick="shareWinners()">🔗 <span data-en="Share Winners"
                                    data-vi="Chia sẻ người thắng">Share Winners</span></button>
                        </div>
                    </div>

                    <div class="history-section">
                        <h2 class="section-title">🏆 <span data-en="Winner History" data-vi="Lịch sử người thắng">Winner
                                History</span></h2>
                        <div id="historyList" class="history-list">
                            <p style="color: var(--text-secondary); text-align: center;" data-en="No winners yet"
                                data-vi="Chưa có người thắng">No winners yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ad Area - Right Side -->
            <div class="ads-right">
                <!-- Insert Google Ads code here -->
                <div class="ad-placeholder">
                    <p>📢 Advertisement Space</p>
                    <small>Right Side Ad Area</small>
                </div>
            </div>
        </div>

        <script>
            // Global state
            let participants = [];
            let winners = [];
            let remainingParticipants = [];
            let isSpinning = false;
            let currentLanguage = 'en'; // 'en' or 'vi'

            // Language translations
            const translations = {
                en: {
                    appTitle: "🎯 Lucky Draw System",
                    appSubtitle: "Fair and secure random selection using cryptographic randomness",
                    participantsList: "Participants List",
                    currentList: "Current List",
                    saveList: "Save List",
                    clear: "Clear",
                    totalParticipants: "Total Participants",
                    remaining: "Remaining",
                    noParticipantsLoaded: "No participants loaded",
                    noParticipantsRemaining: "No participants remaining",
                    congratulations: "CONGRATULATIONS!",
                    spinning: "Spinning...",
                    spin: "SPIN!",
                    resetWinners: "Reset Winners",
                    resetAll: "Reset All",
                    exportWinners: "Export Winners",
                    winnerHistory: "Winner History",
                    noWinnersYet: "No winners yet",
                    light: "Light",
                    dark: "Dark",
                    festival: "Festival",
                    language: "Language",
                    resultHash: "Result Hash",
                    timestamp: "Timestamp",
                    exportedOn: "Exported on",
                    luckyDrawWinners: "Lucky Draw Winners",
                    pleaseEnterParticipants: "Please enter at least one participant!",
                    confirmResetWinners: "Are you sure you want to reset the winner history?",
                    confirmResetAll: "Are you sure you want to reset everything? This will clear all data.",
                    noWinnersToExport: "No winners to export!",
                    shareWinners: "Share Winners",
                    shareYourWinners: "Share Your Winners!",
                    shareLinkText: "Share this link with others to show your lucky draw results:",
                    copyLink: "Copy Link",
                    openLink: "Open Link",
                    close: "Close",
                    linkCopied: "Link copied to clipboard!",
                    errorSharingWinners: "Error sharing winners: ",
                    unknownError: "Unknown error",
                    errorSharingWinnersTryAgain: "Error sharing winners. Please try again.",
                    createYourOwnDraw: "Create Your Own Draw"
                },
                vi: {
                    appTitle: "🎯 Hệ thống Quay số may mắn",
                    appSubtitle: "Lựa chọn ngẫu nhiên công bằng và an toàn sử dụng mã hóa",
                    participantsList: "Danh sách tham gia",
                    currentList: "Danh sách hiện tại",
                    saveList: "Lưu danh sách",
                    clear: "Xóa",
                    totalParticipants: "Tổng số tham gia",
                    remaining: "Còn lại",
                    noParticipantsLoaded: "Chưa có người tham gia",
                    noParticipantsRemaining: "Không còn người tham gia",
                    congratulations: "CHÚC MỪNG!",
                    spinning: "Đang quay...",
                    spin: "QUAY!",
                    resetWinners: "Đặt lại người thắng",
                    resetAll: "Đặt lại tất cả",
                    exportWinners: "Xuất người thắng",
                    winnerHistory: "Lịch sử người thắng",
                    noWinnersYet: "Chưa có người thắng",
                    light: "Sáng",
                    dark: "Tối",
                    festival: "Lễ hội",
                    language: "Ngôn ngữ",
                    resultHash: "Mã hash kết quả",
                    timestamp: "Thời gian",
                    exportedOn: "Xuất lúc",
                    luckyDrawWinners: "Danh sách người thắng quay số",
                    pleaseEnterParticipants: "Vui lòng nhập ít nhất một người tham gia!",
                    confirmResetWinners: "Bạn có chắc muốn đặt lại lịch sử người thắng?",
                    confirmResetAll: "Bạn có chắc muốn đặt lại tất cả? Điều này sẽ xóa toàn bộ dữ liệu.",
                    noWinnersToExport: "Không có người thắng để xuất!",
                    shareWinners: "Chia sẻ người thắng",
                    shareYourWinners: "Chia sẻ người thắng!",
                    shareLinkText: "Chia sẻ liên kết này với người khác để hiển thị kết quả quay số:",
                    copyLink: "Sao chép liên kết",
                    openLink: "Mở liên kết",
                    close: "Đóng",
                    linkCopied: "Đã sao chép liên kết vào clipboard!",
                    errorSharingWinners: "Lỗi chia sẻ người thắng: ",
                    unknownError: "Lỗi không xác định",
                    errorSharingWinnersTryAgain: "Lỗi chia sẻ người thắng. Vui lòng thử lại.",
                    createYourOwnDraw: "Tạo quay số của riêng bạn"
                }
            };

            // Initialize app
            document.addEventListener('DOMContentLoaded', function () {
                loadFromStorage();
                updateDisplay();
                loadLanguagePreference();
            });

            // Language management
            function setLanguage(lang) {
                currentLanguage = lang;
                localStorage.setItem('luckyDrawLanguage', lang);
                updateLanguageDisplay();
            }

            function toggleLanguage() {
                const newLang = currentLanguage === 'en' ? 'vi' : 'en';
                setLanguage(newLang);
            }

            function updateLanguageDisplay() {
                // Update all elements with data-en and data-vi attributes
                document.querySelectorAll('[data-en][data-vi]').forEach(element => {
                    const key = element.getAttribute(`data-${currentLanguage}`);
                    if (translations[currentLanguage][key]) {
                        element.textContent = translations[currentLanguage][key];
                    }
                });

                // Update placeholders
                const textarea = document.getElementById('participantsInput');
                textarea.placeholder = textarea.getAttribute(`data-${currentLanguage}-placeholder`);

                // Update dynamic content
                updateDisplay();
                updateHistory();

                // Update header elements
                const appTitle = document.getElementById('appTitle');
                const appSubtitle = document.getElementById('appSubtitle');
                if (appTitle) appTitle.textContent = translations[currentLanguage].appTitle;
                if (appSubtitle) appSubtitle.textContent = translations[currentLanguage].appSubtitle;
            }

            function loadLanguagePreference() {
                const savedLang = localStorage.getItem('luckyDrawLanguage') || 'en';
                setLanguage(savedLang);
            }

            // Theme management
            function setTheme(theme) {
                document.body.setAttribute('data-theme', theme);
                document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                localStorage.setItem('luckyDrawTheme', theme);
            }

            // Load saved theme
            const savedTheme = localStorage.getItem('luckyDrawTheme') || 'light';
            setTheme(savedTheme);

            // Fisher-Yates Shuffle with crypto RNG
            function shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(getCryptoRandom() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            // Get cryptographically secure random number
            function getCryptoRandom() {
                const array = new Uint32Array(1);
                window.crypto.getRandomValues(array);
                return array[0] / (0xffffffff + 1);
            }

            // Parse participants from textarea
            function parseParticipants(text) {
                return text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
            }

            // Save participants list
            function saveList() {
                const input = document.getElementById('participantsInput').value;
                participants = parseParticipants(input);

                if (participants.length === 0) {
                    alert(translations[currentLanguage].pleaseEnterParticipants);
                    return;
                }

                // Initialize remaining participants (excluding previous winners)
                remainingParticipants = participants.filter(p => !winners.includes(p));

                updateDisplay();
                saveToStorage();

                // Enable spin button if there are remaining participants
                document.getElementById('spinBtn').disabled = remainingParticipants.length === 0;
            }

            // Clear input
            function clearInput() {
                document.getElementById('participantsInput').value = '';
                participants = [];
                remainingParticipants = [];
                updateDisplay();
                document.getElementById('spinBtn').disabled = true;
            }

            // Update display
            function updateDisplay() {
                const display = document.getElementById('participantsDisplay');
                const totalEl = document.getElementById('totalParticipants');
                const remainingEl = document.getElementById('remainingParticipants');

                totalEl.textContent = participants.length;
                remainingEl.textContent = remainingParticipants.length;

                if (remainingParticipants.length === 0) {
                    display.innerHTML = `<p style="color: var(--text-secondary); text-align: center;">${translations[currentLanguage].noParticipantsRemaining}</p>`;
                    return;
                }

                display.innerHTML = remainingParticipants
                    .map(participant => `<div class="participant-item">${participant}</div>`)
                    .join('');
            }

            // Start spinning animation
            function startSpin() {
                if (isSpinning || remainingParticipants.length === 0) return;

                isSpinning = true;
                document.getElementById('spinBtn').disabled = true;

                // Hide winner section
                document.getElementById('winnerSection').classList.add('hidden');

                // Show countdown
                const countdownEl = document.getElementById('countdown');
                const spinnerEl = document.getElementById('spinner');

                countdownEl.classList.remove('hidden');
                spinnerEl.classList.add('hidden');

                let count = 3;
                countdownEl.textContent = count;

                const countdownInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdownEl.textContent = count;
                        countdownEl.classList.add('shake');
                        setTimeout(() => countdownEl.classList.remove('shake'), 500);
                    } else {
                        clearInterval(countdownInterval);
                        countdownEl.classList.add('hidden');
                        spinnerEl.classList.remove('hidden');

                        // Start spinning animation
                        let spinCount = 0;
                        const maxSpins = 20;
                        const spinInterval = setInterval(() => {
                            const randomIndex = Math.floor(getCryptoRandom() * remainingParticipants.length);
                            const spinningText = currentLanguage === 'vi' ? 'Đang quay...' : 'Spinning...';
                            spinnerEl.innerHTML = `🎲 ${remainingParticipants[randomIndex]} 🎲`;
                            spinCount++;

                            if (spinCount >= maxSpins) {
                                clearInterval(spinInterval);
                                selectWinner();
                            }
                        }, 100);
                    }
                }, 1000);
            }

            // Select winner
            function selectWinner() {
                // Use Fisher-Yates shuffle for fair selection
                const shuffled = shuffleArray(remainingParticipants);
                const winner = shuffled[0];

                // Remove winner from remaining participants
                remainingParticipants = remainingParticipants.filter(p => p !== winner);
                winners.push(winner);

                // Generate result hash for transparency
                const timestamp = new Date().toISOString();
                const hashInput = timestamp + winner;
                generateHash(hashInput).then(hash => {
                    displayWinner(winner, timestamp, hash);
                });

                updateDisplay();
                saveToStorage();

                isSpinning = false;
                document.getElementById('spinBtn').disabled = remainingParticipants.length === 0;
                document.getElementById('spinner').classList.add('hidden');
            }

            // Display winner
            function displayWinner(winner, timestamp, hash) {
                const winnerSection = document.getElementById('winnerSection');
                const winnerName = document.getElementById('winnerName');
                const resultHash = document.getElementById('resultHash');

                winnerName.textContent = winner;
                resultHash.textContent = `${translations[currentLanguage].resultHash}: ${hash}\n${translations[currentLanguage].timestamp}: ${timestamp}`;

                winnerSection.classList.remove('hidden');
                winnerSection.classList.add('fade-in');

                // Update history
                updateHistory();
            }

            // Generate SHA-256 hash
            async function generateHash(input) {
                const encoder = new TextEncoder();
                const data = encoder.encode(input);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }

            // Update winner history
            function updateHistory() {
                const historyList = document.getElementById('historyList');

                if (winners.length === 0) {
                    historyList.innerHTML = `<p style="color: var(--text-secondary); text-align: center;">${translations[currentLanguage].noWinnersYet}</p>`;
                    return;
                }

                historyList.innerHTML = winners
                    .map((winner, index) => {
                        const time = new Date().toLocaleString();
                        return `
                        <div class="history-item fade-in">
                            <span class="history-winner">#${index + 1}: ${winner}</span>
                            <span class="history-time">${time}</span>
                        </div>
                    `;
                    })
                    .join('');
            }

            // Reset winners
            function resetWinners() {
                if (confirm(translations[currentLanguage].confirmResetWinners)) {
                    winners = [];
                    remainingParticipants = [...participants];
                    updateDisplay();
                    updateHistory();
                    saveToStorage();
                    document.getElementById('winnerSection').classList.add('hidden');
                    document.getElementById('spinBtn').disabled = remainingParticipants.length === 0;
                }
            }

            // Reset all
            function resetAll() {
                if (confirm(translations[currentLanguage].confirmResetAll)) {
                    participants = [];
                    winners = [];
                    remainingParticipants = [];
                    document.getElementById('participantsInput').value = '';
                    updateDisplay();
                    updateHistory();
                    document.getElementById('winnerSection').classList.add('hidden');
                    document.getElementById('spinBtn').disabled = true;
                    localStorage.removeItem('luckyDrawData');
                }
            }

            // Export winners
            function exportWinners() {
                if (winners.length === 0) {
                    alert(translations[currentLanguage].noWinnersToExport);
                    return;
                }

                const content = `${translations[currentLanguage].luckyDrawWinners}\n${'='.repeat(20)}\n\n` +
                    winners.map((winner, index) => `${index + 1}. ${winner}`).join('\n') +
                    `\n\n${translations[currentLanguage].exportedOn}: ${new Date().toLocaleString()}`;

                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lucky-draw-winners-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // Share winners via API
            async function shareWinners() {
                if (winners.length === 0) {
                    alert(translations[currentLanguage].noWinnersToExport);
                    return;
                }

                try {
                    const response = await fetch('/public/api/save-draw.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            winners: winners
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Show share URL
                        showShareUrl(data.share_url);
                    } else {
                        alert(translations[currentLanguage].errorSharingWinners + (data.error || translations[currentLanguage].unknownError));
                    }
                } catch (error) {
                    console.error('Error sharing winners:', error);
                    alert(translations[currentLanguage].errorSharingWinnersTryAgain);
                }
            }

            // Show share URL modal
            function showShareUrl(shareUrl) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;

                const content = document.createElement('div');
                content.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 12px;
                max-width: 500px;
                width: 90%;
                text-align: center;
            `;

                content.innerHTML = `
                <h3 style="margin-bottom: 20px; color: var(--primary-color);">🎉 ${translations[currentLanguage].shareYourWinners}</h3>
                <p style="margin-bottom: 20px; color: var(--text-secondary);">${translations[currentLanguage].shareLinkText}</p>
                <div style="background: var(--surface); padding: 15px; border-radius: 8px; margin-bottom: 20px; word-break: break-all; font-family: monospace; border: 1px solid var(--border);">
                    ${shareUrl}
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="copyToClipboard('${shareUrl}')" style="padding: 10px 20px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer;">
                        📋 ${translations[currentLanguage].copyLink}
                    </button>
                    <button onclick="window.open('${shareUrl}', '_blank')" style="padding: 10px 20px; background: var(--success-color); color: white; border: none; border-radius: 6px; cursor: pointer;">
                        🔗 ${translations[currentLanguage].openLink}
                    </button>
                    <button onclick="this.closest('.modal').remove()" style="padding: 10px 20px; background: var(--text-secondary); color: white; border: none; border-radius: 6px; cursor: pointer;">
                        ✕ ${translations[currentLanguage].close}
                    </button>
                </div>
            `;

                modal.appendChild(content);
                modal.classList.add('modal');
                document.body.appendChild(modal);

                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            // Copy to clipboard function
            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    alert(translations[currentLanguage].linkCopied);
                }).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert(translations[currentLanguage].linkCopied);
                });
            }

            // Save to localStorage
            function saveToStorage() {
                const data = {
                    participants,
                    winners,
                    remainingParticipants,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('luckyDrawData', JSON.stringify(data));
            }

            // Load from localStorage
            function loadFromStorage() {
                const saved = localStorage.getItem('luckyDrawData');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        participants = data.participants || [];
                        winners = data.winners || [];
                        remainingParticipants = data.remainingParticipants || [];

                        // Update input field
                        document.getElementById('participantsInput').value = participants.join('\n');

                        updateHistory();
                    } catch (e) {
                        console.error('Error loading saved data:', e);
                    }
                }
            }
        </script>
    </body>

</html>
